# Service Workers

Плохой интернет, когда нужно загрузить картинку весом как чугунный мост. В эпоху очень быстрого интернета мы стали забывать о том, что в некоторых локациях нашего мира нет хорошей сети (например, когда вы едете в поезде по нашей необъятной стране). Эту проблему довольно хорошо решают Service Workers

## Что такое Service Workers?

- Service Workers - worker, который создает отдельный и изолированный контекст выполнения, работающий параллельно с основным потоком в приложении. С помощью Service Worker'a, можно перехватывать сетевые запросы, эффективно реализовывать кэширование файлов, push-уведомления, фоновую синхронизацию и оффлайн доступность приложения.
- Event Loop Service Workers - полностью асинхронный, поэтому Service Worker не может использовать синхронные API, такие как Local Storage/Session Storage и тд, также Service Worker не имеет доступа к DOM. Service Worker работает только по HTTPS из соображений безопасности.
- N.B. Мы можем запустить только один Service Worker на странице, если вы попытаетесь создать более одного Service Worker'a на странице, то он просто подменит предыдущий.

## Жизненный цикл Service Worker

### Регистрация
На этом этапе мы регистрируем наш Service Worker, с помощью следующего кода:

```JavaScript
// 'service-worker.js' - путь до файла нашего Service Worker'a
navigator.serviceWorker.register('service-worker.js')
```
### Установка
После регистрации Service Worker загружает файл service-worker.js. На этом этапе Service Worker выполняет метод ***oninstall***, где мы можем закэшировать ресурсы.

```JavaScript
// Имя кэша
const CACHE_NAME = 'cache_v1';
// слушаем событие установки
self.addEventListener('install', (event) => {
  // предотвращает завершение события до тех пор, пока не завершится асинхронная операция(используется, чтобы Service Worker не был деактивирован браузером)
  event.waitUntil((async () => {
    // берем объект кэша и добавляем туда наши файлы
    const cache = await caches.open(CACHE_NAME);
    await cache.add('fallback.html');
  })());
});
```
### Ожидание активации
После успешной установки, Service Worker переходит в состояние ожидание активации. Он остается в этом состоянии, пока нет другой версии Service Worker, активированной на сайте.

### Активация
Когда не существует активных Service Workers, текущий Service Worker активируется. В этот момент он выполняет метод onactivate. В этом методе можно выполнять различные операции, например, удаление устаревших кэшированных ресурсов.

```JavaScript
// слушаем событие активации
self.addEventListener('activate', async () => {
  // получаем имена кэшей
  const cacheNames = await caches.keys();
  await Promise.all(cacheNames.map(async (cacheName) => {
    // Удаляем кэши, которые не относятся к текущей версии
    if (cacheName !== CACHE_NAME) {
      await caches.delete(cacheName);
    }
  }));
});
```
### Активное состояние
После успешной активации, Service Worker может перехватывать сетевые запросы с помощью метода ***fetch***, управлять кэшем, отправлять уведомления браузера и выполнять другие задачи.

```JavaScript
// реализация Network-First стратегии кэширования
// слушаем событие fetch
self.addEventListener('fetch', async event => {
  try {
    // пробуем получить запрос из сети
    return await fetch(event.request);
  } catch (error) {
    // если произошла ошибка достаем данные из кэша
    return await caches.match(event.request);
  }
});
```

### Замена
В этой части жизненного цикла рассматривается случай, когда регистрируется новая версия Service Worker (например, при обновлении нашего приложения), новая версия проходит все этапы установки и активации затем новая версия активируется после того, как не будет активных клиентов, использующих предыдущую версию Service Worker. В свою очередь, старая версия Service Worker переходит в режим "ожидание активации" и ожидает деактивации.

### Деактивация и удаление
Деактивация происходит в нескольких случаях:
- Браузер решает, что Service Worker больше не нужен для обслуживания активных клиентов
- Изменения в коде Service Worker или обновление страницы

Удаление происходит в нескольких случаях:
- Автоматическое удаление браузером после деактивации
- Удаление разработчиком
```JavaScript
self.registration.unregister()
```

![Диаграмма жизненного цикла Service Worker](https://github.com/wmcheck/Notes/assets/2428660/0df4ea71-f58a-4ea3-9661-e05e3638cfab)

Подробный разбор темы, статья ![Джейка Арчибальда](https://web.dev/articles/service-worker-lifecycle)
